generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                String          @id @default(cuid())
  schoolStudentCode Int             @unique
  schoolAdminCode   Int             @unique
  name              String
  createdAt         DateTime        @default(now())
  backgroundInfo    String?
  rigorLevels       String[]        @default([])
  admins            Administrator[]
  clubs             Club[]
  courses           Course[]
  programs          Program[]
  sports            Sport[]
  students          Student[]
}

model User {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  middleName    String?
  preferredName String?
  email         String   @unique
  createdAt     DateTime @default(now())
  passwordHash  String
  gender        String

  role UserRole

  // Relations to specific role tables
  student Student?
  admin   Administrator?

  sessions Session[]
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  expiresAt DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model Administrator {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  school   School? @relation(fields: [schoolId], references: [id])
  schoolId String?
}

model Student {
  gradeLevel         Int
  graduationYear     Int
  dateOfBirth        DateTime?
  bio                String?
  interests          String[]
  subjectInterests   String[] // e.g., "Science", "Math", "English", "History"
  desiredCourseRigor String?

  collegePlanSummary String? @db.Text()

  // Future Plans
  postHighSchoolPlan String?
  careerInterest     String?
  interestedInNCAA   Boolean @default(false)

  // Study Halls
  studyHallsPerYear    Int? @default(0)
  maxStudyHallsPerYear Int? @default(0)

  // RELATIONSHIPS
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  school   School? @relation(fields: [schoolId], references: [id])
  schoolId String?

  // Activities
  clubs  Club[] @relation("ClubToStudent")
  sports Sport[] @relation("SportToStudent")

  clubRecommendations ClubRecommendation[]

  // Course relationship through junction table
  studentCourses StudentCourse[]

  // Real relationship to Colleges
  targetColleges College[] @relation("CollegeToStudent")
  focusPrograms  Program[] @relation("ProgramToStudent")
  savedOpportunities Opportunity[] @relation("OpportunityToStudent")
  opportunityRecommendations OpportunityRecommendation[]
  
  // Persisted AI Analysis
  latestOpportunityAnalysis String? // Markdown analysis for opportunities
  latestClubAnalysis        String? // Markdown analysis for clubs
  latestCourseAnalysis      String? // Markdown analysis for courses

  goals Goal[]
}

model Program {
  id          String  @id @default(cuid())
  name        String // e.g. "JROTC", "Fine Arts", "Welding"
  description String? // e.g. "Army JROTC Leadership Track"

  // Link to School (Required - Programs are school-specific)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Link to Students
  students Student[] @relation("ProgramToStudent")

  @@unique([name, schoolId]) // Prevent duplicate program names in the same school
}

model College {
  id   String @id @default(cuid())
  name String @unique

  // Category field (e.g., "University", "Technical", "Military")
  type String

  requirements String[]
  suggestions  String[]

  students Student[] @relation("CollegeToStudent")
}

model Club {
  id             String  @id @default(cuid())
  name           String
  category       String // e.g. "Service", "Academic"
  description    String?
  teacherLeader  String?
  studentLeaders String?

  // Link to School (Required)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Students who joined this club
  students Student[] @relation("ClubToStudent")
  
  recommendedTo ClubRecommendation[]

  // Unique name PER school (Two schools can both have "Beta Club")
  @@unique([name, schoolId])
}

model ClubRecommendation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  reason String
  timing String // "NOW" | "FUTURE"

  studentId String
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  clubId String
  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([studentId, clubId])
}

model Sport {
  id     String @id @default(cuid())
  name   String
  season String // "Fall", "Winter", "Spring"
  gender String // "Men's", "Women's", "Co-ed"

  // Link to School (Required)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  students Student[] @relation("SportToStudent")

  // Unique name PER school
  @@unique([name, schoolId])
}

model Course {
  id         String  @id @default(cuid())
  name       String
  department String // "Math", "English"
  code       String? // "MAT-101"

  level           String? // "AP", "H", "CP"
  credits         Float? // 1.0, 0.5
  availableGrades Int[] // [9, 10, 11, 12]
  requirements    String[] // ["FINE_ARTS_CREDIT"]
  countsForGrad   Boolean  @default(true)
  prerequisites   String? // "ART-DRAWING-1"
  bundleId        String? // "BUNDLE-..."
  programTag      String? // "BAND" 

  // Link to School (Required)
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Course relationship through junction table
  students StudentCourse[]

  // Unique name PER school
  @@unique([name, schoolId])
}

model StudentCourse {
  id String @id @default(cuid())

  // Foreign keys
  studentId String
  courseId  String

  // Course information
  grade           String? // "A", "B+", "C", etc.
  status          CourseStatus @default(IN_PROGRESS)
  confidenceLevel String? // "VERY_LOW", "LOW", "NEUTRAL", "HIGH", "VERY_HIGH" - only for IN_PROGRESS and NEXT_SEMESTER
  stressLevel     String? // "VERY_LOW", "LOW", "NEUTRAL", "HIGH", "VERY_HIGH" - only for IN_PROGRESS and NEXT_SEMESTER
  gradeLevel      Int? // The grade (9, 10, 11, 12) when this course was/will be taken

  // Relations
  student Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Composite unique constraint - one entry per student per course
  @@unique([studentId, courseId])
}

model Opportunity {
  id              String    @id @default(cuid())
  originalId      String?   @unique
  title           String
  organization    String
  locationJson    String
  within45Min     Boolean
  type            String
  paid            Boolean
  paidDescription String?
  timeOfYear      String
  timeCommitment  String
  eligibility     String
  deadline        String
  description     String
  link            String
  students        Student[] @relation("OpportunityToStudent")
  recommendedTo   OpportunityRecommendation[]
}

model OpportunityRecommendation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  matchReason String
  actionPlan  String
  generatedTags String[] @default([])

  studentId String
  student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([studentId, opportunityId])
}

model Goal {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  title       String
  status      String   @default("PENDING") // PENDING, COMPLETED
  priority    String   @default("Medium") // High, Medium, Low
  steps       Json?    // Array of strings or objects
  aiAnalysis  String?  // Reasoning/Advice
  metadata    Json?    // Stores context like time, location, origin opportunity ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([studentId])
}

enum UserRole {
  STUDENT
  ADMIN
}

enum CourseStatus {
  COMPLETED
  IN_PROGRESS
  NEXT_SEMESTER
  PLANNED
}

enum ConfidenceLevel {
  VERY_LOW
  LOW
  NEUTRAL
  HIGH
  VERY_HIGH
}
